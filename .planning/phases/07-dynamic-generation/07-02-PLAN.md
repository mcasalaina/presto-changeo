---
phase: 07-dynamic-generation
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified: [backend/mode_generator.py]
autonomous: true

must_haves:
  truths:
    - "Generator calls Azure OpenAI with Pydantic schema"
    - "Generation completes in under 3 seconds"
    - "Generated config is valid Mode object"
  artifacts:
    - path: "backend/mode_generator.py"
      provides: "Async mode generation orchestrator"
      exports: ["generate_mode"]
      min_lines: 80
  key_links:
    - from: "mode_generator.py"
      to: "generation_schemas.py"
      via: "response_format=GeneratedModeConfig"
      pattern: "response_format.*GeneratedModeConfig"
    - from: "mode_generator.py"
      to: "color_utils.py"
      via: "derive_theme_palette call"
      pattern: "derive_theme_palette"
---

<objective>
Create the async mode generator that calls Azure OpenAI Structured Outputs to generate complete mode configurations for arbitrary industries.

Purpose: Enable "Presto-Change-O, you're a pet store" to generate a complete, usable mode configuration using LLM for creative decisions (tabs, metrics, personality) and algorithms for derivation (colors, data consistency).

Output: Mode generator module that produces valid Mode objects from arbitrary industry requests.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-dynamic-generation/07-RESEARCH.md
@.planning/phases/07-dynamic-generation/07-CONTEXT.md
@.planning/phases/07-dynamic-generation/07-01-SUMMARY.md

Existing infrastructure:
@backend/modes.py
@backend/azure_client.py
@backend/generation_schemas.py
@backend/color_utils.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create mode generator with Azure OpenAI Structured Outputs</name>
  <files>backend/mode_generator.py</files>
  <action>
Create the async mode generator that produces complete Mode objects for arbitrary industries.

**Architecture from research:**
- Use `beta.chat.completions.parse()` with `response_format=GeneratedModeConfig` for 100% schema adherence
- Use AsyncAzureOpenAI for async generation
- Derive theme palette algorithmically from LLM-suggested primary color

**Implementation:**

1. **Imports:**
   - `from openai import AsyncAzureOpenAI`
   - `from backend.generation_schemas import GeneratedModeConfig`
   - `from backend.color_utils import derive_theme_palette`
   - `from backend.modes import Mode, ModeTheme, ModeTab, ModeMetric`
   - `from backend.azure_client import get_credential` (for auth)

2. **GENERATION_SYSTEM_PROMPT** constant:
   ```
   You are a mode configuration generator for a multi-industry dashboard app.
   Generate a complete configuration for the requested industry.

   Guidelines:
   - primary_color: Choose a color that represents this industry (hex format)
   - tabs: Include 4-5 relevant tabs. Always include "dashboard" (first) and "settings" (last)
   - default_metrics: Include 4 key metrics/KPIs relevant to this industry
   - personality_traits: 3-5 traits that define how the AI assistant should behave
   - system_prompt_fragment: Additional context for the AI (industry jargon, common questions)
   - welcome_message: Friendly greeting when entering this mode

   Be creative but realistic. The dashboard should feel purpose-built for this industry.
   ```

3. **async def generate_mode(industry: str) -> Mode:**
   - Create AsyncAzureOpenAI client using get_credential() and environment vars
   - Call `client.beta.chat.completions.parse()` with:
     - `model="model-router"` (from PROJECT.md)
     - `messages=[system_prompt, user_message]`
     - `response_format=GeneratedModeConfig`
   - Extract parsed config from response
   - Derive full theme palette using `derive_theme_palette(config.primary_color)`
   - Build and return Mode object:
     - `id`: config.industry_id
     - `name`: config.industry_name
     - `theme`: ModeTheme(**derived_palette)
     - `tabs`: [ModeTab(**t.model_dump()) for t in config.tabs]
     - `system_prompt`: Build full prompt from config.system_prompt_fragment + standard tools context
     - `default_metrics`: [ModeMetric(**m.model_dump()) for m in config.default_metrics]

4. **Build full system prompt** helper:
   - Combine config.system_prompt_fragment with standard visualization tools instructions
   - Include config.personality_traits as guidance
   - Use same tool instructions format as existing modes (show_chart, show_metrics)

**Error handling:**
- Wrap in try/except for API errors
- Log errors but don't crash - return None on failure
- Caller can fall back to default mode

**Azure auth:** Use existing pattern from azure_client.py - get_credential() with DefaultAzureCredential.
  </action>
  <verify>python -c "import asyncio; from backend.mode_generator import generate_mode; print('Generator module OK')"</verify>
  <done>generate_mode function is importable and has correct signature</done>
</task>

<task type="auto">
  <name>Task 2: Test generation with sample industry</name>
  <files>backend/mode_generator.py</files>
  <action>
Add a simple test block at the bottom of mode_generator.py that can be run directly.

```python
if __name__ == "__main__":
    import asyncio

    async def test_generation():
        print("Testing mode generation for 'pet store'...")
        mode = await generate_mode("pet store")
        if mode:
            print(f"Generated mode: {mode.name}")
            print(f"Theme primary: {mode.theme.primary}")
            print(f"Tabs: {[t.label for t in mode.tabs]}")
            print(f"Metrics: {[m.label for m in mode.default_metrics]}")
        else:
            print("Generation failed")

    asyncio.run(test_generation())
```

This allows manual testing with `python backend/mode_generator.py`.

**Do NOT run this as part of verification** - it requires Azure credentials and makes API calls.
The verify step just checks the module imports correctly.
  </action>
  <verify>python -c "from backend.mode_generator import generate_mode; import inspect; assert inspect.iscoroutinefunction(generate_mode); print('generate_mode is async')"</verify>
  <done>Test block added, module structure verified</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `python -c "from backend.mode_generator import generate_mode"` succeeds
- [ ] generate_mode is an async function (coroutine)
- [ ] Module imports all dependencies correctly
- [ ] GENERATION_SYSTEM_PROMPT constant exists
</verification>

<success_criteria>
- All tasks completed
- Mode generator module importable without errors
- Uses Azure OpenAI Structured Outputs pattern from research
- Derives colors algorithmically (not from LLM)
- Returns valid Mode object compatible with existing infrastructure
</success_criteria>

<output>
After completion, create `.planning/phases/07-dynamic-generation/07-02-SUMMARY.md`
</output>
