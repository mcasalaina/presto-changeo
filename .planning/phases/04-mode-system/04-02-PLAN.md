---
phase: 04-mode-system
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - backend/modes.py
  - backend/chat.py
  - backend/main.py
autonomous: true

must_haves:
  truths:
    - "Banking, Insurance, Healthcare mode configs exist with unique themes"
    - "Presto-Change-O commands are detected in chat messages"
    - "mode_switch WebSocket message sent when mode changes"
  artifacts:
    - path: "backend/modes.py"
      provides: "Pre-built mode configurations"
      contains: "MODES ="
    - path: "backend/chat.py"
      provides: "Mode detection and switching logic"
      contains: "presto-change-o"
  key_links:
    - from: "backend/chat.py"
      to: "frontend via WebSocket"
      via: "mode_switch message"
      pattern: '"type":\\s*"mode_switch"'
---

<objective>
Create pre-built mode configurations and backend mode switching logic.

Purpose: Enable the AI to detect "Presto-Change-O" commands and switch modes with appropriate themes and behaviors.
Output: Three pre-built modes (Banking, Insurance, Healthcare) and chat handler mode detection.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Previous plan establishes types
@.planning/phases/04-mode-system/04-01-SUMMARY.md

# Existing chat handler patterns
@backend/chat.py
@backend/tools.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create pre-built mode configurations</name>
  <files>backend/modes.py</files>
  <action>
Add pre-built mode configurations to `backend/modes.py` after the Pydantic models:

```python
# Pre-built mode configurations
MODES: dict[str, Mode] = {
    "banking": Mode(
        id="banking",
        name="Banking",
        theme=ModeTheme(
            primary="#1E88E5",      # Blue - trust, stability
            secondary="#43A047",    # Green - money, growth
            background="#f8fafc",
            surface="#ffffff",
            text="#0f172a",
            text_muted="#64748b"
        ),
        tabs=[
            ModeTab(id="dashboard", label="Dashboard", icon="ðŸ“Š"),
            ModeTab(id="accounts", label="Accounts", icon="ðŸ’³"),
            ModeTab(id="transfers", label="Transfers", icon="ðŸ’¸"),
            ModeTab(id="payments", label="Payments", icon="ðŸ“‹"),
            ModeTab(id="settings", label="Settings", icon="âš™ï¸"),
        ],
        system_prompt="""You are a helpful banking assistant for a digital banking dashboard. You help customers with their accounts, transactions, and financial questions.

Keep responses clear, professional, and concise. Speak naturally like a friendly bank representative.

You have access to visualization tools to display data in the dashboard:
- show_chart: Display charts (line, bar, pie, area) with data points
- show_metrics: Display key metrics/KPIs in the metrics panel

IMPORTANT: When you use a visualization tool, you MUST ALWAYS also provide a brief text response describing what you're showing.""",
        default_metrics=[
            ModeMetric(label="Account Balance", value="$24,856.42"),
            ModeMetric(label="Recent Transactions", value=12),
            ModeMetric(label="Pending Payments", value=3),
            ModeMetric(label="Credit Score", value=742),
        ]
    ),
    "insurance": Mode(
        id="insurance",
        name="Insurance",
        theme=ModeTheme(
            primary="#7B1FA2",      # Purple - protection, premium
            secondary="#00897B",    # Teal - calm, trust
            background="#faf5ff",
            surface="#ffffff",
            text="#1e1b4b",
            text_muted="#6b7280"
        ),
        tabs=[
            ModeTab(id="dashboard", label="Dashboard", icon="ðŸ“Š"),
            ModeTab(id="policies", label="Policies", icon="ðŸ“„"),
            ModeTab(id="claims", label="Claims", icon="ðŸ“"),
            ModeTab(id="coverage", label="Coverage", icon="ðŸ›¡ï¸"),
            ModeTab(id="settings", label="Settings", icon="âš™ï¸"),
        ],
        system_prompt="""You are a helpful insurance assistant for a digital insurance dashboard. You help customers with their policies, claims, and coverage questions.

Keep responses clear, professional, and empathetic. Speak naturally like a caring insurance advisor.

You have access to visualization tools to display data in the dashboard:
- show_chart: Display charts (line, bar, pie, area) with data points
- show_metrics: Display key metrics/KPIs in the metrics panel

IMPORTANT: When you use a visualization tool, you MUST ALWAYS also provide a brief text response describing what you're showing.""",
        default_metrics=[
            ModeMetric(label="Active Policies", value=3),
            ModeMetric(label="Total Coverage", value="$750,000"),
            ModeMetric(label="Pending Claims", value=1),
            ModeMetric(label="Next Premium", value="$245", unit="/mo"),
        ]
    ),
    "healthcare": Mode(
        id="healthcare",
        name="Healthcare",
        theme=ModeTheme(
            primary="#00ACC1",      # Cyan - clean, medical
            secondary="#E53935",    # Red - health, urgency
            background="#f0fdfa",
            surface="#ffffff",
            text="#134e4a",
            text_muted="#64748b"
        ),
        tabs=[
            ModeTab(id="dashboard", label="Dashboard", icon="ðŸ“Š"),
            ModeTab(id="appointments", label="Appointments", icon="ðŸ“…"),
            ModeTab(id="records", label="Records", icon="ðŸ“‹"),
            ModeTab(id="prescriptions", label="Prescriptions", icon="ðŸ’Š"),
            ModeTab(id="settings", label="Settings", icon="âš™ï¸"),
        ],
        system_prompt="""You are a helpful healthcare assistant for a digital health dashboard. You help patients with their appointments, medical records, and health questions.

Keep responses clear, professional, and compassionate. Speak naturally like a caring healthcare coordinator.

You have access to visualization tools to display data in the dashboard:
- show_chart: Display charts (line, bar, pie, area) with data points
- show_metrics: Display key metrics/KPIs in the metrics panel

IMPORTANT: When you use a visualization tool, you MUST ALWAYS also provide a brief text response describing what you're showing.""",
        default_metrics=[
            ModeMetric(label="Upcoming Appointments", value=2),
            ModeMetric(label="Active Prescriptions", value=4),
            ModeMetric(label="Deductible Met", value="68%"),
            ModeMetric(label="Out-of-Pocket", value="$1,240"),
        ]
    ),
}

def get_mode(mode_id: str) -> Mode | None:
    """Get a mode configuration by ID."""
    return MODES.get(mode_id.lower())

def get_all_modes() -> list[Mode]:
    """Get all available mode configurations."""
    return list(MODES.values())

# Current active mode (module-level state, like conversation_history)
_current_mode: str = "banking"

def get_current_mode() -> Mode:
    """Get the current active mode."""
    return MODES[_current_mode]

def set_current_mode(mode_id: str) -> Mode | None:
    """Set the current active mode. Returns the mode if valid, None if not found."""
    global _current_mode
    mode = get_mode(mode_id)
    if mode:
        _current_mode = mode_id.lower()
        return mode
    return None
```
  </action>
  <verify>
    - `python -c "from modes import MODES, get_mode; print(get_mode('banking').name)"` prints "Banking"
    - `python -c "from modes import MODES; print(len(MODES))"` prints 3
  </verify>
  <done>Three pre-built modes configured with unique themes, tabs, and system prompts</done>
</task>

<task type="auto">
  <name>Task 2: Add mode detection to chat handler</name>
  <files>backend/chat.py</files>
  <action>
Update `backend/chat.py` to detect "Presto-Change-O" commands and switch modes:

1. Import mode functions at top:
```python
from modes import get_mode, get_current_mode, set_current_mode
```

2. Add mode detection function before `handle_chat_message`:
```python
import re

def detect_mode_switch(text: str) -> str | None:
    """
    Detect if the user is requesting a mode switch.
    Returns the mode ID if detected, None otherwise.

    Patterns matched:
    - "Presto-Change-O, you're a bank"
    - "presto change o youre a healthcare provider"
    - "Presto-Change-O, you're an insurance company"
    """
    # Normalize: lowercase, remove punctuation except spaces
    normalized = re.sub(r"[^\w\s]", "", text.lower())

    # Check for the trigger phrase
    if "presto change o" not in normalized and "presto changeo" not in normalized:
        return None

    # Look for industry keywords
    if any(word in normalized for word in ["bank", "banking", "financial"]):
        return "banking"
    if any(word in normalized for word in ["insurance", "insurer", "policy"]):
        return "insurance"
    if any(word in normalized for word in ["health", "healthcare", "medical", "hospital", "doctor"]):
        return "healthcare"

    return None
```

3. Modify `handle_chat_message` to check for mode switch BEFORE calling LLM:

At the start of the function, after the `logger.info` line, add:
```python
    # Check for mode switch command
    new_mode_id = detect_mode_switch(text)
    if new_mode_id:
        new_mode = set_current_mode(new_mode_id)
        if new_mode:
            logger.info(f"Mode switched to: {new_mode.name}")

            # Clear conversation history on mode switch
            clear_history()

            # Send mode_switch message to frontend
            await websocket.send_text(json.dumps({
                "type": "mode_switch",
                "payload": {
                    "mode": {
                        "id": new_mode.id,
                        "name": new_mode.name,
                        "theme": new_mode.theme.model_dump(),
                        "tabs": [tab.model_dump() for tab in new_mode.tabs],
                        "defaultMetrics": [m.model_dump() for m in new_mode.default_metrics]
                    }
                }
            }))

            # Notify frontend that response is starting
            await websocket.send_text(json.dumps({
                "type": "chat_start",
                "payload": {}
            }))

            # Send a welcome message for the new mode
            welcome = f"âœ¨ Presto-Change-O! I'm now your {new_mode.name} assistant. How can I help you today?"
            await websocket.send_text(json.dumps({
                "type": "chat_chunk",
                "payload": {"text": welcome, "done": False}
            }))
            await websocket.send_text(json.dumps({
                "type": "chat_chunk",
                "payload": {"text": "", "done": True}
            }))
            return
```

4. Update the SYSTEM_PROMPT usage to be dynamic:

Replace the hardcoded `SYSTEM_PROMPT` constant with getting it from current mode:
```python
# Change: messages = [SystemMessage(content=SYSTEM_PROMPT)]
# To: messages = [SystemMessage(content=get_current_mode().system_prompt)]
```

Remove or comment out the old hardcoded SYSTEM_PROMPT constant (keep it as a fallback comment for reference).
  </action>
  <verify>
    - `python -c "from chat import detect_mode_switch; print(detect_mode_switch('Presto-Change-O, you\\'re a bank'))"` prints "banking"
    - `python -c "from chat import detect_mode_switch; print(detect_mode_switch('hello there'))"` prints "None"
    - `python -c "from chat import handle_chat_message"` succeeds (no import errors)
  </verify>
  <done>Mode detection working, mode_switch messages sent via WebSocket, dynamic system prompts</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Backend starts without errors: `python main.py` (briefly)
- [ ] Mode detection returns correct IDs for test phrases
- [ ] `python -c "from modes import MODES; print([m.name for m in MODES.values()])"` shows all three modes
- [ ] `python -c "from chat import detect_mode_switch"` imports successfully
- [ ] No Python syntax or import errors
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No errors or warnings introduced
- Three modes fully configured with distinct themes
- Mode switching detected and communicated to frontend
  </success_criteria>

<output>
After completion, create `.planning/phases/04-mode-system/04-02-SUMMARY.md`
</output>
