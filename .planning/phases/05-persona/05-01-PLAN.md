---
phase: 05-persona
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/persona.py
  - backend/chat.py
  - backend/requirements.txt
autonomous: true

must_haves:
  truths:
    - "Same seed produces identical persona data every time"
    - "Banking persona has checking balance, savings balance, credit score"
    - "Insurance persona has active policies, claims history, premium info"
    - "Healthcare persona has appointments, prescriptions, deductible progress"
    - "AI system prompt includes persona details for contextual responses"
  artifacts:
    - path: "backend/persona.py"
      provides: "Pydantic persona models and Faker-based generators"
      min_lines: 100
      exports: ["BankingPersona", "InsurancePersona", "HealthcarePersona", "generate_persona"]
    - path: "backend/chat.py"
      provides: "Persona generation on mode switch, persona context in system prompt"
      contains: "generate_persona"
  key_links:
    - from: "chat.py mode switch handler"
      to: "generate_persona()"
      via: "function call on mode switch"
      pattern: "generate_persona\\("
    - from: "chat.py system prompt builder"
      to: "persona data"
      via: "f-string interpolation"
      pattern: "persona.*name|balance|policy"
---

<objective>
Backend persona generation with Faker-based seeded data for all three industry modes.

Purpose: Enable consistent, industry-appropriate fake customer data that the AI can reference naturally. Same session = same persona = no contradictions.

Output: Working persona generation system integrated into mode switch flow with persona context injected into AI system prompts.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-persona/05-RESEARCH.md
@.planning/phases/05-persona/05-CONTEXT.md

# Source files to modify:
@backend/modes.py
@backend/chat.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create persona models and generators</name>
  <files>backend/persona.py, backend/requirements.txt</files>
  <action>
Create backend/persona.py with:

1. Add faker>=40.0.0 to requirements.txt

2. Pydantic models for each industry:
   - Transaction (date, description, amount, category)
   - BankingPersona (name, member_since, checking_balance, savings_balance, account_number_last4, credit_score, credit_limit, recent_transactions)
   - Policy (type, coverage, premium, deductible, policy_number, renewal_date)
   - Claim (claim_id, date, type, amount, status)
   - InsurancePersona (name, member_since, active_policies, claims_history, total_coverage, monthly_premium, risk_score)
   - Appointment (date, time, provider, specialty, location)
   - Prescription (medication, dosage, frequency, refills_remaining)
   - HealthcarePersona (name, member_id, date_of_birth, primary_care_provider, plan_name, deductible, deductible_met, out_of_pocket_max, out_of_pocket_spent, upcoming_appointments, active_prescriptions)

3. Generator functions using Faker with seed_instance():
   - generate_banking_persona(seed: int) -> BankingPersona
   - generate_insurance_persona(seed: int) -> InsurancePersona
   - generate_healthcare_persona(seed: int) -> HealthcarePersona

4. Factory function:
   - generate_persona(mode_id: str, seed: int) -> dict
   - Returns persona.model_dump() for the mode, or empty dict for unknown mode

Key implementation details:
- Use fake.seed_instance(seed) NOT Faker.seed(seed) â€” instance seeding for multi-session isolation
- Realistic value ranges: checking $500-15000, savings $1000-50000, credit scores 620-820
- Generate 5-10 recent transactions for banking
- Generate 1-3 policies for insurance
- Generate 1-3 prescriptions and 0-2 upcoming appointments for healthcare
- Use fake.date_between() for realistic date ranges
  </action>
  <verify>
python -c "from backend.persona import generate_persona; p1 = generate_persona('banking', 12345); p2 = generate_persona('banking', 12345); assert p1 == p2, 'Seeding broken'; print('Seeding verified:', p1['name'])"
  </verify>
  <done>
- All three persona types generate correctly from seed
- Same seed produces identical data
- Faker installed and working
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate persona into mode switch flow</name>
  <files>backend/chat.py</files>
  <action>
Modify backend/chat.py to:

1. Import persona generation:
   from persona import generate_persona

2. Add module-level persona state (similar to conversation history):
   _current_persona: dict = {}

3. Add session seed derivation function:
   import hashlib

   def get_session_seed() -> int:
       """Get deterministic seed. For now, use a fixed seed per session.
       In multi-connection setup, derive from WebSocket connection ID."""
       # Simple implementation: use hash of a session marker
       # TODO: In production, derive from actual session/connection ID
       return int(hashlib.md5(b"demo-session").hexdigest()[:8], 16)

4. In detect_mode_switch handling (after set_current_mode succeeds):
   - Generate persona: _current_persona = generate_persona(new_mode_id, get_session_seed())
   - Include persona in mode_switch message payload:
     "persona": _current_persona

5. Create build_system_prompt function:
   def build_system_prompt(mode: Mode, persona: dict) -> str:
       base = mode.system_prompt
       if not persona:
           return base

       # Build persona context based on mode type
       if mode.id == "banking":
           persona_context = f"""
Current Customer Profile:
- Name: {persona.get('name')}
- Member Since: {persona.get('member_since')}
- Checking Balance: ${persona.get('checking_balance', 0):,.2f}
- Savings Balance: ${persona.get('savings_balance', 0):,.2f}
- Credit Score: {persona.get('credit_score')}

Reference this customer's information naturally in your responses."""
       elif mode.id == "insurance":
           persona_context = f"""
Current Customer Profile:
- Name: {persona.get('name')}
- Member Since: {persona.get('member_since')}
- Active Policies: {len(persona.get('active_policies', []))}
- Total Coverage: ${persona.get('total_coverage', 0):,.2f}
- Monthly Premium: ${persona.get('monthly_premium', 0):,.2f}

Reference this customer's information naturally in your responses."""
       elif mode.id == "healthcare":
           persona_context = f"""
Current Patient Profile:
- Name: {persona.get('name')}
- Member ID: {persona.get('member_id')}
- Primary Care Provider: {persona.get('primary_care_provider')}
- Deductible Progress: ${persona.get('deductible_met', 0):,.2f} of ${persona.get('deductible', 0):,.2f}
- Active Prescriptions: {len(persona.get('active_prescriptions', []))}

Reference this patient's information naturally in your responses."""
       else:
           persona_context = ""

       return f"{base}\n\n{persona_context}" if persona_context else base

6. Update the LLM call to use build_system_prompt:
   Replace: messages = [SystemMessage(content=current_mode.system_prompt)]
   With: messages = [SystemMessage(content=build_system_prompt(current_mode, _current_persona))]
  </action>
  <verify>
python -c "from backend.chat import get_session_seed, build_system_prompt; from backend.modes import get_mode; from backend.persona import generate_persona; seed = get_session_seed(); persona = generate_persona('banking', seed); prompt = build_system_prompt(get_mode('banking'), persona); assert 'Customer Profile' in prompt; print('Persona integration verified')"
  </verify>
  <done>
- Persona generated on mode switch
- Persona included in mode_switch WebSocket message
- System prompt includes persona context for AI
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `pip install -r backend/requirements.txt` succeeds
- [ ] `python -c "from backend.persona import generate_persona"` succeeds
- [ ] Persona seeding is deterministic (same seed = same data)
- [ ] All three industry personas generate valid data
- [ ] System prompt includes persona context
</verification>

<success_criteria>

- All tasks completed
- Faker installed and generating personas
- Same seed produces identical persona data
- Persona context appears in system prompts
- mode_switch message includes persona payload
</success_criteria>

<output>
After completion, create `.planning/phases/05-persona/05-01-SUMMARY.md`
</output>
